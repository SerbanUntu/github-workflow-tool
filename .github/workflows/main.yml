name: Java CI/CD

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - '**'
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Execute Gradle tests
        run: ./gradlew test

  package:
    name: Build & Release
    needs: test
    if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && github.base_ref == 'main')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Extract Project Version
        id: get_version
        run: |
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "PROJECT_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Detected version: $VERSION"

      - name: Create Portable Distribution
        run: ./gradlew installDist -x test

      - name: Zip Distribution
        run: |
          cd build/install
          DIR_NAME=$(ls -d */ | head -n 1 | tr -d /)
          zip -r "../../ghwork@${{ env.PROJECT_VERSION }}.zip" "$DIR_NAME"

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest' }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'Latest Build' }}
          artifacts: "ghwork@${{ env.PROJECT_VERSION }}.zip"
          allowUpdates: true
          replacesArtifacts: true
          prerelease: ${{ github.event_name == 'pull_request' }}
          makeLatest: ${{ github.event_name != 'pull_request' }}